<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Greentech/Graficos</title>
	<link rel="stylesheet" href="../css/styleDash.css">
    <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>

</head>
<body>
	<!-- Div main é todo o corpo do pagina (tudo)-->

	<div class="main">
		<!-- Barra de navegação lateral-->

		<div class="navbar">
			<ul>
				<h4 class="item-navbar" id="greenName">Greentech</h4>
				<img id='img_user' src="../assets/imgs/user.jpg" alt="" class="item-navbar">
				<h5 class="item-navbar" id="username"></h5>
				<p class="item-navbar" id="cargo">Gerente de vendas</p>
				<a href="dashboard.html"><li class="item-navbar">Home</li></a>
			<li class="item-navbar" id="aqui">Dashboard</li>
				<a href="contato.html"><li class="item-navbar">Contato</li></a>
				<li class="item-navbar">Ajustes</li>
			</ul>
		</div>
			<!-- Div container é tudo que ficou na parte da box -->

			<div class="container">

				<div class="titulos-grafico">
					<div style="display: flex; justify-content:center; align-items:center">
						<h1>Estufa Leste II</h1>
					</div>
					<div style="display: flex; justify-content:center; align-items:center; flex-direction: column;">
						<div class="num-metrica">
							<div class="metrica-bar">
								<div id="bola-bar-red">
									<p>Alerta</p>
								</div>
								<div id="bola-bar-orange">
									<p>Cuidado</p>
								</div>	
								<div id="bola-bar-green">
									<p>Normal</p>
								</div>
								<div id="bola-bar-orange">
									<p>Cuidado</p>
								</div>
								<div id="bola-bar-red">
									<p>Alerta</p>
								</div>
								<div id="bola-bar-silver">
									<p>Inativa</p>
								</div>
							</div>
					</div>

				<!-- Colocando as métricas de forma numérica -->
				
				<div class="num-metrica" style="margin-top: 10px">

					<div class="num-metrica-green">
						<p style="color: red; font-weight: 700;">14 °C</p>
						<p style="color: red; font-weight: 700;">60%</p>
					</div>

					<div class="num-metrica-green">
						<p style="color: orange; font-weight: 700;">18 °C</p>
						<p style="color: orange; font-weight: 700;">64%</p>
					</div>

					<div class="num-metrica-green">
						<p style="color: green; font-weight: 700;">21 °C</p>
						<p style="color: green; font-weight: 700;">70%</p>
						
					</div>

					<div class="num-metrica-green">
						<p style="color: orange; font-weight: 700;">25 °C</p>
						<p style="color: orange; font-weight: 700;">77%</p>
					</div>

					<div class="num-metrica-green">
						<p style="color: red; font-weight: 700;">27 °C</p>
						<p style="color: red; font-weight: 700;">80%</p>
					</div>

					<div class="num-metrica-green">
						<p style="color: grey; font-weight: 700;">0 °C</p>
						<p style="color: grey; font-weight: 700;">0%</p>
					</div>

				</div>

			</div>

			</div>
			
				<!--Primeiras caixas para informaçoes gerais-->

				<!--Div das box com os dados precisos do dashboard-->
				<!-- Limite de caracteres da nome da estufa é 11-->
				<div class="box-data">
					<div class="boxes-data">
						<div class="div-estufas">
						<p>Norte</p> <div class="aviso-normal"></div>
						
					</div>

					<div class="div-estufas">
						<p>Leste</p> <div class="aviso-perigo"></div>
						
					</div>

					<div class="div-estufas">
						<p>Leste II</p> <div class="aviso-cuidado"></div>

					</div>
					
					<div class="div-estufas">
						<p>Sul</p> <div class="aviso-normal"></div>
			
					</div>

					<div class="div-estufas">
						<p>Sul II</p> <div class="aviso-normal"></div>
			
					</div>

					<div class="div-estufas">
						<p>Leste III</p> <div class="aviso-off"></div>
			
					</div>

					<div class="div-estufas">
						<p>Norte II</p> <div class="aviso-normal"></div>
			
					</div>

					<div class="div-estufas">
						<p>Oeste</p> <div class="aviso-normal"></div>
			
					</div>

					<div class="div-estufas">
						<p>Oeste II</p> <div class="aviso-off"></div>
			
					</div>

					
					</div>

					<!--Fazendo a parte das informações numéricas-->

					<!--Div grafico-->

					<div class="boxes-metrica-grafico">
						<div id="btn-grafico">
							<button onclick="temperatura()" class="btn-opcao-grafico">Temperatura</button><button onclick="umidade()" class="btn-opcao-grafico">Umidade</button>
						</div>
						<!-- <div id="btn-grafico">
							<button>Semanal</button><button>Mensal</button><button>Diario</button>
						</div> -->
						<!-- <div class="box-graficos" id="grafico-media">
							<div>
								<canvas id="myChart" width="180px" height="180px"></canvas>
							</div>
							<div>
								<canvas id="myChart2" width="180px" height="180px"></canvas>
							</div>
						</div> -->
						<div class="box-graficos" id="graficoTemperatura">
							<div>
								<canvas id="myChart3" width="450px" height="220px"></canvas>
							</div>
						</div>
						
						<div class="box-graficos" id="graficoUmidade" style="display: none;">
							<div>
								<canvas id="myChart4" width="450px" height="220px"></canvas>
							</div>
						</div>

					</div>
	</div>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

	username.innerHTML = `${sessionStorage.getItem('NOME_USUARIO')}`;

</script>

<script>
	const labelsTemperaturaPie = [
	  'Temperatura'
	];
  
	const dataTemperaturaPie = {
	  labels: labelsTemperaturaPie,
	  datasets: [{
		label: 'Temperatura',
		backgroundColor: ['green', 'white'],
		data: [24, 15]
	  }],
	};

	const labelsUmidadePie = [
	  'Umidade'
	];
  
	const dataUmidadePie = {
	  labels: labelsUmidadePie,
	  datasets: [{
		label: 'Umidade',
		backgroundColor: ['blue', 'white'],
		data: [80, 20]
	  }],
	};
  
	const configTemperaturaPie = {
	  type: 'doughnut',
	  data: dataTemperaturaPie,
	  options: {
		circumference: 180, 
		rotation: 270,
		responsive: true,
		maintainAspectRatio: false,
		plugins: {
			title: {
				display: true,
				text: 'Temperatura',
				position: 'bottom',	
			}
		}
	  }
	};

	const configUmidadePie = {
	  type: 'doughnut',
	  data: dataUmidadePie,
	  options: {
		circumference: 180, 
		rotation: 270,
		responsive: true,
		maintainAspectRatio: false,
		plugins: {
			title: {
				display: true,
				text: 'Umidade',
				position: 'bottom',	
			}
		}
	  }
	};

	const labelsLine = [
		'Domingo',
		'Segunda-Feira',
		'Terça-Feira',
		'Quarta-Feira',
		'Quinta-Feira',
		'Sexta-Feira',
		'Sábado',
	];

	const dataLineTemp = {
		labels: labelsLine,
		datasets: [
			{
				label: 'Temperatura',
				data: [28, 25, 23, 22, 25, 23, 29],
				backgroundColor: 'green',
				borderColor: 'green'		
			}
		]
	};

	const dataLineUmidade = {
		labels: labelsLine,
		datasets: [
			{
				label: 'Umidade',
				data: [74, 78, 89, 93, 85, 88, 73],
				backgroundColor: 'blue',
				borderColor: 'blue'
			}
		]
	};

	const configLineTemp = {
		type: 'line',
		data: dataLineTemp,
		options: {
			circumference: 180, 
			rotation: 270,
			responsive: true,
			maintainAspectRatio: true,
			scales: {
				y: {
					min: 0,
					max: 100,
				}
			}
		}
	};

	const configLineUmidade = {
		type: 'line',
		data: dataLineUmidade,
		options: {
			circumference: 180, 
			rotation: 270,
			responsive: true,
			maintainAspectRatio: false,
			scales: {
				y: {
					min: 0,
					max: 100,
				}
			}
		}
	};

  </script>
 
 <script>
	// const myChart = new Chart(
	//   document.getElementById('myChart'),
	//   configTemperaturaPie
	// );

	// const myChart2 = new Chart(
	//   document.getElementById('myChart2'),
	//   configUmidadePie
	// );

	const myChart4 = new Chart(
		document.getElementById('myChart4'),
		configLineUmidade
	);

	function temperatura(){
		if(window.graficoTemp){
			window.graficoTemp.destroy();
		}
		obterDadosGraficoTemp(1);
	}

	function umidade(){
		if(window.graficoTemp){
			window.graficoTemp.destroy();
		}
		obterDadosGraficoUmid(1);
	}

    let proximaAtualizacao;

	//SOCORRRO
	function obterDadosGraficoTemp(idEstufa) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idEstufa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGraficoTemp(resposta, idEstufa);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

	function obterDadosGraficoUmid(idEstufa) {

		if (proximaAtualizacao != undefined) {
			clearTimeout(proximaAtualizacao);
		}

		fetch(`/medidas/ultimas/${idEstufa}`, { cache: 'no-store' }).then(function (response) {
			if (response.ok) {
				response.json().then(function (resposta) {
					console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
					resposta.reverse();

					plotarGraficoUmid(resposta, idEstufa);
				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});
	}

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGraficoTemp(resposta, idEstufa) {
        console.log('iniciando plotagem do gráfico...');

        var dados = {
            labels: [],
            datasets: [
                {
                    label: 'Temperatura',
                    borderColor: '#FFF',
                    backgroundColor: 'green',
                    fill: true,
                    data: []
                }
            ]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.temperatura);
        }

        console.log(JSON.stringify(dados));

        const configLine = {
			type: 'line',
            data: dados,
            options: {
				maintainAspectRatio: true,
                responsive: true,
                animation: { duration: 300 },
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: false,
                    text: 'Dados capturados'
                },
                scales: {
                    y: {
						min: 0,
						max: 40,
					}
                }
            }
        };

		var ctx = document.getElementById('myChart3').getContext('2d');
		window.graficoTemp = new Chart (ctx, configLine);


        setTimeout(() => atualizarGraficoTemp(idEstufa, dados), 1000);
    }

	function plotarGraficoUmid(resposta, idEstufa) {
        console.log('iniciando plotagem do gráfico...');

        var dados = {
            labels: [],
            datasets: [
                {
                    label: 'Umidade',
                    borderColor: '#FFF',
                    backgroundColor: 'blue',
                    fill: true,
                    data: []
                }
            ]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.umidade);
        }

        console.log(JSON.stringify(dados));

        const configLine = {
			type: 'line',
            data: dados,
            options: {
				maintainAspectRatio: true,
                responsive: true,
                animation: { duration: 300 },
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: false,
                    text: 'Dados capturados'
                },
                scales: {
                    y: {
						min: 0,
						max: 100,
					}
                }
            }
        };

		var ctx = document.getElementById('myChart3').getContext('2d');
		window.graficoTemp = new Chart (ctx, configLine);


        setTimeout(() => atualizarGraficoUmid(idEstufa, dados), 1000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGraficoTemp(idEstufa, dados) {

        fetch(`/medidas/tempo-real/${idEstufa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico: ${dados}`);

                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
                    
                    dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                    window.graficoTemp.update();

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGraficoTemp(idEstufa, dados), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGraficoTemp(idEstufa, dados), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

	function atualizarGraficoUmid(idEstufa, dados) {

		fetch(`/medidas/tempo-real/${idEstufa}`, { cache: 'no-store' }).then(function (response) {
			if (response.ok) {
				response.json().then(function (novoRegistro) {

					console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
					console.log(`Dados atuais do gráfico: ${dados}`);

					// tirando e colocando valores no gráfico
					dados.labels.shift(); // apagar o primeiro
					dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
					
					dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
					dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de temperatura

					window.graficoTemp.update();

					// Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
					proximaAtualizacao = setTimeout(() => atualizarGraficoUmid(idEstufa, dados), 2000);
				});
			} else {
				console.error('Nenhum dado encontrado ou erro na API');
				// Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
				proximaAtualizacao = setTimeout(() => atualizarGraficoUmid(idEstufa, dados), 2000);
			}
		})
			.catch(function (error) {
				console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
			});

	}

  </script>
