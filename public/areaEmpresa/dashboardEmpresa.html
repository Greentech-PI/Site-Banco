<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<link rel="stylesheet" href="../css/styleDash.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
	<!-- Div main é todo o corpo do pagina (tudo)-->

	<div class="main">
		<!-- Barra de navegação lateral-->

		<div class="navbar">
			<ul>
				<h4 class="item-navbar" id="greenName">Greentech</h4>
				<img id='img_user' src="../assets/imgs/Basic_Ui_(186).jpg" alt="" class="item-navbar">
				<h5 class="item-navbar" id="username"></h5>
				<p class="item-navbar" id="cargo">Representante</p>
				<a href="dashboardEmpresa.html"><li class="item-navbar" id="aqui">Dashboard</li></a>
			    <a href="grafico.html">	<li class="item-navbar" >Estufas</li> </a>
				<a href="alertas.html"><li class="item-navbar">Alertas</li></a>
				<li class="item-navbar">Contato</li>
                <a href="cadastroUser.html"><li class="item-navbar">Cadastrar Func</li></a>
				<a href="cadastroEstufa.html"><li class="item-navbar">Cadastrar Estufa</li></a>
			</ul>
		</div>

			<!-- Div container é tudo que ficou na parte da box -->

			<div class="container">

				<div class="titulos">
				<h1 id="nomeEmpresa">Fazenda Carabellum</h1>

				<div id="organizar-titulo">
				<div class="metrica-bar">	
					<div id="bola-bar-green">
						<p>Normal</p>
					</div>
					<div id="bola-bar-orange">
						<p>Cuidado</p>
					</div>
					<div id="bola-bar-red">
						<p>Alerta</p>
					</div>
					<div id="bola-bar-silver">
						<p>Inativa</p>
					</div>
				</div>

				<!-- Colocando as métricas de forma numérica -->
				
				
				<!-- <div class="num-metrica">

					<div class="num-metrica-green">
						<p style="color: green; font-weight: 700;">12 °C</p>
						<p style="color: green; font-weight: 700;">36%</p>					
					</div>

					<div class="num-metrica-green">
						<p style="color: orange; font-weight: 700;">12 °C</p>
						<p style="color: orange; font-weight: 700;">36%</p>
					</div>

					<div class="num-metrica-green">
						<p style="color: red; font-weight: 700;">12 °C</p>
						<p style="color: red; font-weight: 700;">36%</p>
					</div>

					<div class="num-metrica-green">
						<p style="color: grey; font-weight: 700;">0 °C</p>
						<p style="color: grey; font-weight: 700;">0%</p>
					</div>
				</div> -->
			</div>

			</div>
			
				<!--Primeiras caixas para informaçoes gerais-->

				<div class="boxes">
					<div class="box">
						<img src="../assets/imgs/greenhouse.png">
						<div class="text">
						<p>Estufas inativas</p>
						<h4 id="txtKpiEstufasInativas">-</h4>
					    </div>    
				    </div>
					<div class="box">
						<img src="../assets/imgs/warning.png">
						<div class="text">
						<p>Cuidado necessário</p>
						<h4 style="color: rgb(185, 31, 31);" id="txtKpiCuidadoNecessario">-</h4>
					    </div>
					</div>
					<div class="box">
						<img src="../assets/imgs/house.png">
						<div class="text">
						<p style="font-size: 13px;">Maior tempo de alarme</p> 
						<h4 id="txtKpiEstufaRecorrente">-</h4>
					    </div>
					</div>
				</div>

				<!--Div das box com os dados precisos do dashboard-->
				<!-- Limite de caracteres da nome da estufa é 11-->
				<div class="box-data">
					<div class="boxes-data" id="corpo_pesquisaEstufas">
						
					</div>

					<!--Fazendo a parte das informações numéricas-->

					<!--Div Principal-->
					<div class="boxes-metrica" id="tabelaTempoReal">


						<div class="titulos"><p>Estufa</p><p>Temperatura</p><p>Umidade</p></div>


						<!-- <div class="div-metrica">
							<div class="div-estufa-name"><p style="color: red; font-weight: bold;">Leste</p></div>
							<div class="temp"><p style="color: red; font-weight: bold;">27.4 °C</p></div>
							<div class="umidade"> <p>71%</p></div>
						</div>
					

						<div class="div-metrica">
						<div class="div-estufa-name"><p style="color: rgb(255, 123, 0); font-weight: bold;">Leste II</p></div>
						<div class="temp"><p>22.7 °C</p></div>
						<div class="umidade"> <p style="color: rgb(255, 123, 0); font-weight: bold;">65%</p></div>
						</div>
					
						<div class="div-metrica">
						<div class="div-estufa-name"><p>Norte</p></div>
						<div class="temp"><p>20.2 °C</p></div>
						<div class="umidade"> <p>72%</p></div>
						</div>

						<div class="div-metrica">
						<div class="div-estufa-name"><p>Sul</p></div>
						<div class="temp"><p>21.5 °C</p></div>
						<div class="umidade"> <p>75%</p></div>
						</div>

						<div class="div-metrica">
						<div class="div-estufa-name"><p>Norte II</p></div>
						<div class="temp"><p>22.2 °C</p></div>
						<div class="umidade"> <p>79%</p></div>
						</div>

						<div class="div-metrica">
						<div class="div-estufa-name"><p>Sul II</p></div>
						<div class="temp"><p>24.8 °C</p></div>
						<div class="umidade"> <p>76%</p></div>
						</div>

						<div class="div-metrica">
						<div class="div-estufa-name"><p>Oeste</p></div>
						<div class="temp"><p>21.1 °C</p></div>
						<div class="umidade"> <p>78%</p></div>
						</div>

						<div class="div-metrica">
						<div class="div-estufa-name"><p style="color: rgb(158, 158, 158);">Leste III</p></div>
						<div class="temp"><p style="color: rgb(158, 158, 158);">0 °C</p></div>
						<div class="umidade"> <p style="color: rgb(158, 158, 158);">0%</p></div>
						</div>

						<div class="div-metrica">
						<div class="div-estufa-name"><p style="color: rgb(158, 158, 158);">Oeste II</p></div>
						<div class="temp"><p style="color: rgb(158, 158, 158);">0 °C</p></div>
						<div class="umidade"> <p style="color: rgb(158, 158, 158);">0%</p></div>
						</div> -->

							
					
						</div>


			</div>
	</div>
</body>
</html>

<script>

	username.innerHTML = `${sessionStorage.getItem('NOME_REPRESENTANTE')}`;

	nomeEmpresa.innerHTML = `${sessionStorage.getItem('NOME_EMPRESA')}`;

</script>

<script>

	var fkEmpresa = sessionStorage.getItem('ID_EMPRESA');

	fetch("/usuarios/buscarEstufas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    fkEmpresa: fkEmpresa
                })
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO buscarEmpresa()!");

                if (resposta.ok) {
					
				
					console.log(resposta);

					resposta.json().then(json => {
						console.log(JSON.stringify(json));
						var contadorId = 1;
						var estufasInativas = 0;
						for(var i = 0; i < json.length; i++){
							var estufa = json[i];

							const divEstufa = document.createElement("div");
							const nomeEstufa = document.createElement("p");
							const divAviso = document.createElement("div");

							if(estufa.fkEstufa != undefined){
								if(estufa.ultimaTemp <= estufa.minTemp || estufa.ultimaTemp >= estufa.maxTemp || estufa.ultimaUmidade <= estufa.minUmidade || estufa.ultimaUmidade >= estufa.maxUmidade) {
									divAviso.className = "aviso-perigo";
								}else if(estufa.ultimaTemp <= estufa.baixaTemp || estufa.ultimaTemp >= estufa.altaTemp || estufa.ultimaUmidade <= estufa.baixaUmidade || estufa.ultimaUmidade >= estufa.altaUmidade) {
									divAviso.className = "aviso-cuidado";
								}else{
									divAviso.className = "aviso-normal";
								}
							}else if(estufa.fkEstufa == undefined) {
								divAviso.className = "aviso-off";
								estufasInativas++;
							}

							divEstufa.className = "div-estufas";

							nomeEstufa.innerHTML = `${estufa.nomeEstufa}`;

							divEstufa.appendChild(nomeEstufa);
							divEstufa.appendChild(divAviso);

							corpo_pesquisaEstufas.appendChild(divEstufa);
						}
						var kpiEstufaInativa = document.getElementById("txtKpiEstufasInativas");
						kpiEstufaInativa.innerHTML = `${estufasInativas}`;
					});
					
				}
			else {
				throw ('Houve um erro na API!');
			}

	}).catch(function (resposta) {
		console.error(resposta);
	});


</script>

<script>

	fetch(`/medidas/buscarEstufaProblema/${fkEmpresa}`, { cache: 'no-store' }).then(function (response){
		if(response.ok){
			console.log(response)
			response.json().then(json =>  {
				console.log(JSON.stringify(json));
				for(var i = 0; i < json.length; i++){
					var empresa = json[i];
					var nomeEmpresa = empresa.nomeEstufa;
					var kpiCuidadoNecessario = document.getElementById("txtKpiCuidadoNecessario");
				kpiCuidadoNecessario.innerHTML = `${nomeEmpresa}`;	
				}
			}); 
		}else {
			console.error('Nenhum dado encontrado ou erro na API');
		}
	}).catch(function (error) {
		console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
	});
	
</script>

<script>

fetch(`/medidas/buscarEstufaRecorrente/${fkEmpresa}`, { cache: 'no-store' }).then(function (response){
		if(response.ok){
			console.log(response)
			response.json().then(json =>  {
				console.log(JSON.stringify(json));
				var qtdeAlertas = 0;
				var nomeEstufa = '';
				for(var i = 0; i < json.length; i++){
					var estufa = json[i];
					if(estufa.qtdeRegistros > qtdeAlertas){
						nomeEstufa = estufa.nomeEstufa;
						qtdeAlertas = estufa.qtdeRegistros;
					}
					var kpiEstufaRecorrente = document.getElementById("txtKpiEstufaRecorrente");
					kpiEstufaRecorrente.innerHTML = `${nomeEstufa}`;	
				}
			}); 
		}else {
			console.error('Nenhum dado encontrado ou erro na API');
		}
	}).catch(function (error) {
		console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
	});

</script>

<script>

	fetch("/usuarios/ultimoRegistroEstufa", {
		method: "POST",
		headers: {
			"Content-Type": "application/json"
		},
		body: JSON.stringify({
			fkEmpresa: fkEmpresa
		})
	}).then(function (resposta) {
		console.log("ESTOU NO THEN DO ultimoRegistroEstufa()!");

		if(resposta.ok) {
			console.log(resposta);
			resposta.json().then(json => {
				console.log(JSON.stringify(json));
				var tabela =  document.getElementById("tabelaTempoReal");
				for(var i = 0; i < json.length; i++){
					var estufa = json[i];
					var div_metrica = document.createElement("div");
					var div_estufa_nome = document.createElement("div");
					var texto_estufa_nome = document.createElement("p");
					var div_temp = document.createElement("div");
					var texto_temp = document.createElement("p");
					var div_umid = document.createElement("div");
					var texto_umid = document.createElement("p");
					
					texto_temp.innerHTML = `${estufa.dht11_temperatura}ºC`;
					texto_umid.innerHTML = `${estufa.dht11_umidade}%`;
					texto_estufa_nome.innerHTML = `${estufa.nomeEstufa}`;

					div_metrica.className = "div-metrica";
					div_estufa_nome.className = "div-estufa-name";
					div_temp.className = "temp";
					div_umid.className = "umidade";

					if(estufa.dht11_temperatura <= estufa.minTemp || estufa.dht11_temperatura >= estufa.maxTemp) {
						texto_temp.className = "metricaCritica";
						if(estufa.dht11_temperatura <= estufa.minTemp){
							novoAlerta('Temperatura Extremamente Baixa', estufa.idMonitoramento);
						}else if(estufa.dht11_temperatura >= estufa.maxTemp){
							novoAlerta('Temperatura Extremamente Alta', estufa.idMonitoramento);
						}else{
							console.log("ERRRROOOOOO");
						}
					}else if(estufa.dht11_temperatura <= estufa.baixaTemp || estufa.dht11_temperatura >= estufa.altaTemp) {
						texto_temp.className = "metricaAlerta";
						if(estufa.dht11_temperatura <= estufa.baixaTemp){
							novoAlerta('Temperatura Baixa', estufa.idMonitoramento);
						}else if(estufa.dht11_temperatura >= estufa.altaTemp){
							novoAlerta('Temperatura Alta', estufa.idMonitoramento);
						}else{
							console.log("ERRRROOOOOO");
						}
					}else{
						texto_temp.className = "metricaNormal";
					}

					if(estufa.dhtt_umidade <= estufa.minUmidade || estufa.dht11_umidade >= estufa.maxUmidade){
						texto_umid.className = "metricaCritica";
						if(estufa.dhtt_umidade <= estufa.minUmidade ){
							novoAlerta('Umidade Extremamente Baixa', estufa.idMonitoramento);
						}else if(estufa.dht11_umidade >= estufa.maxUmidade){
							novoAlerta('Umidade Extremamente Alta', estufa.idMonitoramento);
						}else{
							console.log("ERRRROOOOOO");
						}
					}else if(estufa.dht11_umidade <= estufa.baixaUmidade || estufa.dht11_umidade >= estufa.altaUmidade){
						texto_umid.className = "metricaAlerta";
						if(estufa.dht11_umidade <= estufa.baixaUmidade){
							novoAlerta('Umidade Baixa', estufa.idMonitoramento);
						}else if(estufa.dht11_umidade >= estufa.altaUmidade){
							novoAlerta('Umidade Alta', estufa.idMonitoramento);
						}else{
							console.log("ERRRROOOOOO");
						}
					}else{
						texto_umid.className = "metricaNormal";
					}

					div_estufa_nome.appendChild(texto_estufa_nome);
					div_temp.appendChild(texto_temp);
					div_umid.appendChild(texto_umid);

					div_metrica.appendChild(div_estufa_nome);
					div_metrica.appendChild(div_temp);
					div_metrica.appendChild(div_umid);

					tabela.appendChild(div_metrica);
				}
			}); 
		}else{
			throw ('Houve um erro na API!');
		}
	}).catch(function (resposta) {
		console.error(resposta);
	});

</script>

<script>

	function novoAlerta(tipoAlerta, fkMonitoramento){
		fetch("/medidas/novoAlerta", {
			method: "POST",
			headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    tipoAlerta: tipoAlerta,
					fkMonitoramento: fkMonitoramento
                })
		}).then(function (resposta){
			console.log(resposta);

			if(resposta.ok){
				console.log("Novo alerta cadastrado")
			}else {
                throw ("Houve um erro ao tentar cadastrar alerta!");
            }
		}).catch(function (resposta) {
            console.log(`ERRO: ${resposta}`);
        });
	}

</script>